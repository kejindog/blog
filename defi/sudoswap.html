<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>什么是 Sudoswap？ | kejindog</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="kejindog blog">
    
    <link rel="preload" href="/blog/assets/css/0.styles.059b3ec9.css" as="style"><link rel="preload" href="/blog/assets/js/app.5dfd60c4.js" as="script"><link rel="preload" href="/blog/assets/js/2.3dfb7180.js" as="script"><link rel="preload" href="/blog/assets/js/12.fae0daa3.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.43533088.js"><link rel="prefetch" href="/blog/assets/js/11.3d782bef.js"><link rel="prefetch" href="/blog/assets/js/13.ade5a4d6.js"><link rel="prefetch" href="/blog/assets/js/14.20c591d9.js"><link rel="prefetch" href="/blog/assets/js/15.c2479734.js"><link rel="prefetch" href="/blog/assets/js/16.1bc7f15e.js"><link rel="prefetch" href="/blog/assets/js/17.e4874c71.js"><link rel="prefetch" href="/blog/assets/js/18.9ab97755.js"><link rel="prefetch" href="/blog/assets/js/19.6774922b.js"><link rel="prefetch" href="/blog/assets/js/20.d3f7a656.js"><link rel="prefetch" href="/blog/assets/js/21.6dd2f26d.js"><link rel="prefetch" href="/blog/assets/js/22.19487688.js"><link rel="prefetch" href="/blog/assets/js/23.58e2da19.js"><link rel="prefetch" href="/blog/assets/js/24.cb18f131.js"><link rel="prefetch" href="/blog/assets/js/25.508b6cb2.js"><link rel="prefetch" href="/blog/assets/js/26.c57c1521.js"><link rel="prefetch" href="/blog/assets/js/27.c12fe7bb.js"><link rel="prefetch" href="/blog/assets/js/3.2f411e6f.js"><link rel="prefetch" href="/blog/assets/js/4.1c5dd491.js"><link rel="prefetch" href="/blog/assets/js/5.c7a46374.js"><link rel="prefetch" href="/blog/assets/js/6.0791d544.js"><link rel="prefetch" href="/blog/assets/js/7.981fd19d.js"><link rel="prefetch" href="/blog/assets/js/8.47fb248b.js"><link rel="prefetch" href="/blog/assets/js/9.b344c8f6.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.059b3ec9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">kejindog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="web3" class="dropdown-title"><span class="title">web3</span> <span class="arrow down"></span></button> <button type="button" aria-label="web3" class="mobile-dropdown-title"><span class="title">web3</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/web3/" class="nav-link">
  基础知识
</a></li><li class="dropdown-item"><!----> <a href="/blog/defi/" class="nav-link router-link-active">
  Defi
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="javascript" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="javascript" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/browser/" class="nav-link">
  浏览器
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/" class="nav-link">
  web
</a></li><li class="dropdown-item"><!----> <a href="/blog/javascript/" class="nav-link">
  javascript
</a></li><li class="dropdown-item"><!----> <a href="/blog/css/" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/blog/canvas/" class="nav-link">
  canvas
</a></li><li class="dropdown-item"><!----> <a href="/blog/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/react/" class="nav-link">
  react
</a></li></ul></div></div><div class="nav-item"><a href="/blog/resource/" class="nav-link">
  资料
</a></div><div class="nav-item"><a href="https://github.com/kejindog/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="web3" class="dropdown-title"><span class="title">web3</span> <span class="arrow down"></span></button> <button type="button" aria-label="web3" class="mobile-dropdown-title"><span class="title">web3</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/web3/" class="nav-link">
  基础知识
</a></li><li class="dropdown-item"><!----> <a href="/blog/defi/" class="nav-link router-link-active">
  Defi
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="javascript" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="javascript" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/browser/" class="nav-link">
  浏览器
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/" class="nav-link">
  web
</a></li><li class="dropdown-item"><!----> <a href="/blog/javascript/" class="nav-link">
  javascript
</a></li><li class="dropdown-item"><!----> <a href="/blog/css/" class="nav-link">
  css
</a></li><li class="dropdown-item"><!----> <a href="/blog/canvas/" class="nav-link">
  canvas
</a></li><li class="dropdown-item"><!----> <a href="/blog/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/react/" class="nav-link">
  react
</a></li></ul></div></div><div class="nav-item"><a href="/blog/resource/" class="nav-link">
  资料
</a></div><div class="nav-item"><a href="https://github.com/kejindog/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/defi/sudoswap.html" aria-current="page" class="active sidebar-link">sudoswap</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/defi/sudoswap.html#sudoswap-是如何工作的" class="sidebar-link">Sudoswap 是如何工作的？</a></li><li class="sidebar-sub-header"><a href="/blog/defi/sudoswap.html#什么是流动资金池" class="sidebar-link">什么是流动资金池？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/defi/sudoswap.html#linear-线性" class="sidebar-link">Linear(线性)</a></li><li class="sidebar-sub-header"><a href="/blog/defi/sudoswap.html#exponential-指数" class="sidebar-link">Exponential(指数)</a></li><li class="sidebar-sub-header"><a href="/blog/defi/sudoswap.html#xyk-常数产品" class="sidebar-link">XYK（常数产品）</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/defi/sudoswap.html#参考" class="sidebar-link">参考</a></li><li class="sidebar-sub-header"><a href="/blog/defi/sudoswap.html#简要描述" class="sidebar-link">简要描述</a></li><li class="sidebar-sub-header"><a href="/blog/defi/sudoswap.html#代码" class="sidebar-link">代码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/defi/sudoswap.html#lssvmpairfactory" class="sidebar-link">LSSVMPairFactory</a></li><li class="sidebar-sub-header"><a href="/blog/defi/sudoswap.html#createpaireth" class="sidebar-link">createPairETH</a></li><li class="sidebar-sub-header"><a href="/blog/defi/sudoswap.html#lssvmrouter" class="sidebar-link">LSSVMRouter</a></li><li class="sidebar-sub-header"><a href="/blog/defi/sudoswap.html#swapethforanynfts" class="sidebar-link">swapETHForAnyNFTs</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="什么是-sudoswap"><a href="#什么是-sudoswap" class="header-anchor">#</a> 什么是 Sudoswap？</h1> <p>sudoswap AMM - 或简称<em>sudoswap</em> - 是一个最小的、省气的自动做市商 (AMM) 协议，它使用可定制的绑定曲线促进 NFT 到代币的互换（反之亦然）。sudoswap 支持 ERC721 NFT，以及所有 ETH 和 ERC20 代币。</p> <p>流动性提供者 (LP) 可以将资产存入单边买入或卖出池，或双边交易池，通过可选的点差买卖 NFT 以获取交易费用。</p> <p>与其他楼层 NFT 协议类似，sudoswap 不区分不同的 ERC721 ID。愿意购买或出售 NFT 的矿池将返回相同的价格，无论哪个 NFT 被送入或送出收藏。</p> <h2 id="sudoswap-是如何工作的"><a href="#sudoswap-是如何工作的" class="header-anchor">#</a> Sudoswap 是如何工作的？</h2> <p>Sudoswap 是 NFT 的 AMM 协议，这意味着用户从流动性池中购买或出售，而不是直接在他们之间进行交易。如果您熟悉 Uniswap，这是一个类似的概念，但适用于 NFT。</p> <p>以下是它的工作原理： 1.流动性提供者将 NFT 和/或 ETH（或 ERC20 代币）存入流动性池。他们选择是否要购买或出售 NFT（或两者）并指定起始价格和联合曲线参数。 2.然后用户可以从这些池中购买 NFT 或将 NFT 出售到这些池中。每次购买或出售一个项目时，购买或出售另一个项目的价格会根据其联合曲线在池中发生变化。 3.流动性提供者可以随时更改其资金池的参数或提取资产。</p> <h2 id="什么是流动资金池"><a href="#什么是流动资金池" class="header-anchor">#</a> 什么是流动资金池？</h2> <p>池或流动性池是一种智能合约，可让您在两种资产之间即时交换。在 sudoswap 上，最常见的池类型是 NFT&lt;&gt;ETH 池，这意味着任何持有该集合中的 NFT 的人都可以立即将它们换成 ETH，反之亦然。</p> <p>池使用联合曲线来确定一种资产与另一种资产交易的相对价格。从池中购买的资产越多，它变得越昂贵。相反，出售给矿池的资产越多，它就越便宜。</p> <p>理想情况下，一个池包含一定数量的两种资产，使用户能够在它们之间来回交换。但是，也可以创建一个只有一种资产的池，这意味着用户只能从池中购买该资产。</p> <p>联合曲线是定义资产价格与其供应之间关系的数学公式。绑定曲线是自动做市商的一个关键特征，因为它们用于通过算法调整资产价格。</p> <p>sudoswap 支持三种类型的结合曲线：linear, exponential, 和 XYK (constant product).</p> <h3 id="linear-线性"><a href="#linear-线性" class="header-anchor">#</a> Linear(线性)</h3> <p>使用线性联合曲线，每次从池中购买物品时，NFT 的价格都会增加一个固定数量（称为“delta” ）。相反，每次将物品出售给矿池时，NFT 的价格都会降低相同的固定金额。</p> <p>例如，流动性提供者可以创建一个 NFT&lt;&gt;ETH 池，其“起始价格”为 1 ETH，“delta ”为 0.1 ETH。假设它们提供足够的流动性，从池中购买一件物品后，NFT 的价格将增加到 1.1 ETH。购买第二件商品后，价格将增加到 1.2 ETH，以此类推。在任何时候，如果将 NFT 出售给矿池，价格将下降 0.1 ETH。</p> <h3 id="exponential-指数"><a href="#exponential-指数" class="header-anchor">#</a> Exponential(指数)</h3> <p>使用指数联合曲线，每次从池中购买物品时，NFT 的价格都会增加一定百分比（也称为“delta” ）。相反，每次将物品出售给矿池时，NFT 的价格都会降低。</p> <p>要计算等量下降，请将百分比转换为小数指数（例如，对于 50%，指数为 1.5）并将价格除以该数字。</p> <p>例如，流动性提供者可能会创建一个 NFT&lt;&gt;ETH 池，其“起始价格”为 2 ETH，“增量”为 50%。假设它们提供了足够的流动性，从池中购买一件物品后，NFT 的价格将增加到 2 + 50% = 3 ETH。购买第二件商品后，价格将增加到 3 + 50% = 4.5 ETH，以此类推。在任何时候，如果将 NFT 出售给矿池，价格将除以 1.5。</p> <h3 id="xyk-常数产品"><a href="#xyk-常数产品" class="header-anchor">#</a> XYK（常数产品）</h3> <p>使用 XYK 曲线，每次从池中购买或出售物品时都会调整 NFT 的价格，以便在每次交易后两个虚拟储备的乘积保持不变。这些虚拟储备对应于池将购买或出售的 NFT 的数量和价值。</p> <p>一个额外的集中度参数允许流动性提供者调整（即收紧或放松）XYK 曲线。
有关如何准确计算 XYK 曲线定价的信息，请参阅技术参考中的 <a href="https://docs.sudoswap.xyz/reference/pricing/" target="_blank" rel="noopener noreferrer">定价<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 页面。</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li>sudoswap lssvm 官方文档 <a href="https://github.com/sudoswap/lssvm-docs/blob/main/docs/index.md" title="sudoswap lssvm" target="_blank" rel="noopener noreferrer">lssvm-docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <hr> <p>作者: 谢伟杰
日期: '2022-11-03'</p> <hr> <h1 id="sudoamm"><a href="#sudoamm" class="header-anchor">#</a> sudoAMM</h1> <h2 id="简要描述"><a href="#简要描述" class="header-anchor">#</a> 简要描述</h2> <p><a href="https://blog.0xmons.xyz/83017366310" target="_blank" rel="noopener noreferrer">此处<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>描述的 AMM 协议的实现。</p> <p>流动性提供者使用“LSSVMPairFactory ”方法为特定的 NFT 集合 部署了一个修改后的最小代理“LSSVMPair ”。
部署的池维护自己的 TOKEN/NFT 库存。然后，用户可以调用池中的各种“swap”功能来交易 TOKEN/NFT。
<code>LSSVMPair</code>是<code>LSSVMPairEnumerable</code>还是<code>LSSVMPairMissingEnumerable</code>，取决于该货币对的<code>ERC721</code>合约是否支持<code>Enumerable</code>。如果不支持，我们实现自己的 ID 集，以便轻松访问池中的 NFT ID。</p> <p>对于实际的代币，NFT 与<code>ERC20</code>或<code>ETH</code> 配对，因此有 4 种配对类型：</p> <ul><li>Missing Enumerable | ETH</li> <li>Missing Enumerable | ERC20</li> <li>Enumerable | ETH</li> <li>Enumerable | ERC20</li></ul> <p><code>LSSVMPair</code>可以是 TOKEN、NFT 或 TRADE 类型。
类型是指池中包含的内容：</p> <ul><li>TOKEN：一个 TOKEN 池有它愿意提供给交易者以换取 NFT 的代币</li> <li>NFT： NFT 池有 NFT，它愿意提供给交易者以换取代币</li> <li>TRADE：交易池允许 TOKEN--&gt;NFT 和 NFT--&gt;TOKEN 交换。</li></ul> <p><code>LSSVMRouter</code>允许在多个<code>LSSVMPair</code>之间购买和出售多个 NFT，也就是说交易者通过<code>LSSVMRouter</code>swap 时，支持跨池(pair/pool)交易</p> <p><code>LSSVMPair</code> <code>swap</code>函数是从最终用户的角度命名的。例如：<code>swapTokenForAnyNFTs</code>表示调用者想要发送 ETH 并接收 NFT。</p> <p>为了确定提供或接收多少 NFT 或代币，每个“LSSVMPair”调用一个符合“ICurve”接口的离散联合曲线合约。<code>LSSVMPair</code>负责更新其状态并执行输入/输出验证。</p> <p><img src="https://github.com/sudoswap/lssvm/raw/main/sudo-diagram.png" alt="lssvm 架构图">
结构还是比较简单的，主要三部分：</p> <ul><li>Pair(LSSVMPair)：NFT 的流动性池，有唯一的 Liquidity Provider 及其设定的 bonding curve；</li> <li>Factory(LSSVMPairFactory)：用来创建 Pair 的智能合约，主要是 LPs 来调用；</li> <li>Router(LSSVMRouter2)：用户可通过 Router 路由到指定的 Pair 进行交易，是一个交易入口；</li></ul> <h2 id="代码"><a href="#代码" class="header-anchor">#</a> 代码</h2> <h3 id="lssvmpairfactory"><a href="#lssvmpairfactory" class="header-anchor">#</a> LSSVMPairFactory</h3> <div class="language-solidity extra-class"><pre class="language-solidity"><code>  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
        KejinPairEnumerableETH _enumerableETHTemplate<span class="token punctuation">,</span>
        KejinPairMissingEnumerableETH _missingEnumerableETHTemplate<span class="token punctuation">,</span>
        KejinPairEnumerableERC20 _enumerableERC20Template<span class="token punctuation">,</span>
        KejinPairMissingEnumerableERC20 _missingEnumerableERC20Template<span class="token punctuation">,</span>
        <span class="token builtin">address</span> <span class="token keyword">payable</span> _protocolFeeRecipient<span class="token punctuation">,</span>  <span class="token comment">// 工厂协议手续费接收者</span>
        <span class="token builtin">uint256</span> _protocolFeeMultiplier          <span class="token comment">// 协议手续费（%）</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//...</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>部署 LSSVMPairFactory 合约时，需提供 6 个参数，其中 4 个模板参数作用于：流动性提供者创建 pair 时根据该 nft<code>ERC721</code>合约是否支持枚举，以及 token 为原生代币 eth 还是<code>ERC20</code>代币，来<code>create</code>继承了相应模板的 Pair。在工厂中所有的 pool（pair）每次交易都会向工厂合约地址支付基于交易总额的手续费</p> <h3 id="createpaireth"><a href="#createpaireth" class="header-anchor">#</a> createPairETH</h3> <p>这里以创建 ETH 池举例（ERC20 池类似）：</p> <ul><li>参数说明：<code>createPairETH</code>参数注解如上，这里需要注意_assetRecipient，只有创建的是单边池时，才可用，若创建的是 trade 双边池，需要设置为 address(0)，使用<code>getAssetRecipient</code>方法来获取 pair 的资产接收者,若为双边池，则<code>getAssetRecipient</code>返回的是 pair 池的地址。_fee（池手续费）只用于双边池，单边池不可用。</li></ul> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">createPairETH</span><span class="token punctuation">(</span>
        IERC721 _nft<span class="token punctuation">,</span>                       <span class="token comment">// nft合约</span>
        ICurve _bondingCurve<span class="token punctuation">,</span>               <span class="token comment">// 数学模型-交易曲线</span>
        <span class="token builtin">address</span> <span class="token keyword">payable</span> _assetRecipient<span class="token punctuation">,</span>    <span class="token comment">// 资产接收者（只有单边池可设置此参数，trade双边池不支持）</span>
        KejinPair<span class="token punctuation">.</span>PoolType _poolType<span class="token punctuation">,</span>       <span class="token comment">// 池类型</span>
        <span class="token builtin">uint128</span> _delta<span class="token punctuation">,</span>                     <span class="token comment">// 每卖出或买入一个nft，价格都会在原有基础上下降或上升的比例</span>
        <span class="token builtin">uint96</span> _fee<span class="token punctuation">,</span>                        <span class="token comment">// trade双边池手续费</span>
        <span class="token builtin">uint128</span> _spotPrice<span class="token punctuation">,</span>                 <span class="token comment">// 初始价格</span>
        <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">calldata</span> _initialNFTIDs   <span class="token comment">// 将nft中指定的nft币转给即将创建的pair</span>
    <span class="token punctuation">)</span><span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>KejinPairETH pair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>
            bondingCurveAllowed<span class="token punctuation">[</span>_bondingCurve<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">&quot;Bonding curve not whitelisted&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Check to see if the NFT supports Enumerable to determine which template to use</span>
        <span class="token builtin">address</span> template<span class="token punctuation">;</span>
        <span class="token comment">// 用erc165合约来判断该nft合约是否支持枚举，并分配不同的模板合约</span>
        try
            <span class="token function">IERC165</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span>_nft<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">supportsInterface</span><span class="token punctuation">(</span>
                INTERFACE_ID_ERC721_ENUMERABLE
            <span class="token punctuation">)</span>
        <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span> isEnumerable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            template <span class="token operator">=</span> isEnumerable
                <span class="token operator">?</span> <span class="token builtin">address</span><span class="token punctuation">(</span>enumerableETHTemplate<span class="token punctuation">)</span>
                <span class="token punctuation">:</span> <span class="token builtin">address</span><span class="token punctuation">(</span>missingEnumerableETHTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> catch <span class="token punctuation">{</span>
            template <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span>missingEnumerableETHTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 利用create opcode部署一个新的eth pair合约</span>
        pair <span class="token operator">=</span> <span class="token function">KejinPairETH</span><span class="token punctuation">(</span>
            <span class="token keyword">payable</span><span class="token punctuation">(</span>
                template<span class="token punctuation">.</span><span class="token function">cloneETHPair</span><span class="token punctuation">(</span>
                    <span class="token keyword">this</span><span class="token punctuation">,</span>
                    _bondingCurve<span class="token punctuation">,</span>
                    _nft<span class="token punctuation">,</span>
                    <span class="token builtin">uint8</span><span class="token punctuation">(</span>_poolType<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 初始化eth pair合约</span>
        <span class="token function">_initializePairETH</span><span class="token punctuation">(</span>
            pair<span class="token punctuation">,</span>
            _nft<span class="token punctuation">,</span>
            _assetRecipient<span class="token punctuation">,</span>
            _delta<span class="token punctuation">,</span>
            _fee<span class="token punctuation">,</span>
            _spotPrice<span class="token punctuation">,</span>
            _initialNFTIDs
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">emit</span> <span class="token function">NewPair</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><div class="language-solidity extra-class"><pre class="language-solidity"><code> <span class="token keyword">function</span> <span class="token function">_initializePairETH</span><span class="token punctuation">(</span>
        KejinPairETH _pair<span class="token punctuation">,</span>
        IERC721 _nft<span class="token punctuation">,</span>
        <span class="token builtin">address</span> <span class="token keyword">payable</span> _assetRecipient<span class="token punctuation">,</span>
        <span class="token builtin">uint128</span> _delta<span class="token punctuation">,</span>
        <span class="token builtin">uint96</span> _fee<span class="token punctuation">,</span>
        <span class="token builtin">uint128</span> _spotPrice<span class="token punctuation">,</span>
        <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">calldata</span> _initialNFTIDs
    <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>

        <span class="token comment">// transfer initial ETH to pair</span>
        <span class="token comment">// 将创建pair时发送的eth直接转给新部署的pair合约</span>
        <span class="token keyword">payable</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span>_pair<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">safeTransferETH</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="lssvmrouter"><a href="#lssvmrouter" class="header-anchor">#</a> LSSVMRouter</h3> <h3 id="swapethforanynfts"><a href="#swapethforanynfts" class="header-anchor">#</a> swapETHForAnyNFTs</h3> <p>拿<code>swapETHForAnyNFTs</code>举例，交易者想要在工厂中用 eth 买一些 nft</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">swapETHForAnyNFTs</span><span class="token punctuation">(</span>
        PairSwapAny<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">calldata</span> swapList<span class="token punctuation">,</span> <span class="token comment">// 可在多个池中购买若干nft</span>
        <span class="token builtin">address</span> <span class="token keyword">payable</span> ethRecipient<span class="token punctuation">,</span>    <span class="token comment">// eth接收者</span>
        <span class="token builtin">address</span> nftRecipient<span class="token punctuation">,</span>            <span class="token comment">// nft接收者</span>
        <span class="token builtin">uint256</span> deadline                 <span class="token comment">// 此swap的有效期</span>
    <span class="token punctuation">)</span>
        <span class="token keyword">external</span>
        <span class="token keyword">payable</span>
        <span class="token function">checkDeadline</span><span class="token punctuation">(</span>deadline<span class="token punctuation">)</span>
        <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span> remainingValue<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
            <span class="token function">_swapETHForAnyNFTs</span><span class="token punctuation">(</span>swapList<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">,</span> ethRecipient<span class="token punctuation">,</span> nftRecipient<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><ul><li>参数说明：swap 结束，会将购买 nft 之后剩下的 eth 转给 ethRecipient,在池中购买的 nfts 会转移到 nftRecipient 中。</li></ul> <p>_swapETHForAnyNFTs 中<code>swapTokenForAnyNFTs</code> 核心方法解读：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code>    <span class="token comment">//遍历所要购买的流动池</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span> i<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numSwaps<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Calculate the cost per swap first to send exact amount of ETH over, saves gas by avoiding the need to send back excess ETH</span>
            <span class="token comment">// 根据数学模型曲线，计算出买numItems个nft一共需要的花费</span>
            <span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">,</span> <span class="token punctuation">,</span> pairCost<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> swapList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pair<span class="token punctuation">.</span><span class="token function">getBuyNFTQuote</span><span class="token punctuation">(</span>
                swapList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>numItems
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Require no error</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>error <span class="token operator">==</span> CurveErrorCodes<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>OK<span class="token punctuation">,</span> <span class="token string">&quot;Bonding curve error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Total ETH taken from sender cannot exceed inputAmount</span>
            <span class="token comment">// because otherwise the deduction from remainingValue will fail</span>
            <span class="token comment">// 第一次执行此循环时，remainingValue为交易者用于这次交易的所有eth</span>
            remainingValue <span class="token operator">-=</span> swapList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pair<span class="token punctuation">.</span>swapTokenForAnyNFTs<span class="token punctuation">{</span>
                value<span class="token punctuation">:</span> pairCost
            <span class="token punctuation">}</span><span class="token punctuation">(</span>
                swapList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>numItems<span class="token punctuation">,</span>  <span class="token comment">// 购买的nft数量</span>
                remainingValue<span class="token punctuation">,</span>        <span class="token comment">// 剩余的eth</span>
                nftRecipient<span class="token punctuation">,</span>          <span class="token comment">// nft接受者</span>
                <span class="token boolean">true</span><span class="token punctuation">,</span>                  <span class="token comment">// 是否通过LSSVMRouter来调用</span>
                msg<span class="token punctuation">.</span>sender             <span class="token comment">// 交易者</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

            unchecked <span class="token punctuation">{</span>
                <span class="token operator">++</span>i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>pair 中的 swapTokenForAnyNFTs：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code>    <span class="token keyword">function</span> <span class="token function">swapTokenForAnyNFTs</span><span class="token punctuation">(</span>
        <span class="token builtin">uint256</span> numNFTs<span class="token punctuation">,</span>                    <span class="token comment">// 购买的nft数量</span>
        <span class="token builtin">uint256</span> maxExpectedTokenInput<span class="token punctuation">,</span>      <span class="token comment">// 剩余的eth</span>
        <span class="token builtin">address</span> nftRecipient<span class="token punctuation">,</span>               <span class="token comment">// nft接受者</span>
        <span class="token builtin">bool</span> isRouter<span class="token punctuation">,</span>                      <span class="token comment">// 是否通过LSSVMRouter来调用</span>
        <span class="token builtin">address</span> routerCaller                <span class="token comment">// 如果isRouter时true，erp token将转移到此地址，但对于eth pair无效</span>
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> virtual nonReentrant <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span> inputAmount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Store locally to remove extra calls</span>
        IKejinPairFactoryLike _factory <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ICurve _bondingCurve <span class="token operator">=</span> <span class="token function">bondingCurve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        IERC721 _nft <span class="token operator">=</span> <span class="token function">nft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Input validation</span>
        <span class="token punctuation">{</span>
            PoolType _poolType <span class="token operator">=</span> <span class="token function">poolType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// swapTokenForAnyNFTs方法名顾名思义：只可能是nft池或者trade池</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>
                _poolType <span class="token operator">==</span> PoolType<span class="token punctuation">.</span>NFT <span class="token operator">||</span> _poolType <span class="token operator">==</span> PoolType<span class="token punctuation">.</span>TRADE<span class="token punctuation">,</span>
                <span class="token string">&quot;Wrong Pool type&quot;</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span>numNFTs <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>numNFTs <span class="token operator">&lt;=</span> _nft<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Ask for &gt; 0 and &lt;= balanceOf NFTs&quot;</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Call bonding curve for pricing information</span>
        <span class="token builtin">uint256</span> protocolFee<span class="token punctuation">;</span>
        <span class="token comment">// 根据要购买的numNFTs（nft数量）结合数学模型，返回总共需要花费多少eth（已加上工厂协议和pair手续费）</span>
        <span class="token comment">// 注意此protocolFee=inputValue.fmul(protocolFeeMultiplier,FixedPointMathLib.WAD);和pair手续费要区分开！</span>
        <span class="token comment">// protocolFeeMultiplier为创建factory合约时的参数：协议费率，为定值</span>
        <span class="token comment">// 函数中已经更新了最新的nft定价spotPrice和增幅delta，并发出事件</span>
        <span class="token punctuation">(</span>protocolFee<span class="token punctuation">,</span> inputAmount<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">_calculateBuyInfoAndUpdatePoolParams</span><span class="token punctuation">(</span>
            numNFTs<span class="token punctuation">,</span>
            maxExpectedTokenInput<span class="token punctuation">,</span>
            _bondingCurve<span class="token punctuation">,</span>
            _factory
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 支付eth或者erc20 token</span>
        <span class="token function">_pullTokenInputAndPayProtocolFee</span><span class="token punctuation">(</span>
            inputAmount<span class="token punctuation">,</span>
            isRouter<span class="token punctuation">,</span>
            routerCaller<span class="token punctuation">,</span>
            _factory<span class="token punctuation">,</span>
            protocolFee
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将numNFTs数量的nft转给nftRecipient</span>
        <span class="token function">_sendAnyNFTsToRecipient</span><span class="token punctuation">(</span>_nft<span class="token punctuation">,</span> nftRecipient<span class="token punctuation">,</span> numNFTs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将购买nft之后剩下的eth返回给caller</span>
        <span class="token function">_refundTokenToSender</span><span class="token punctuation">(</span>inputAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">emit</span> <span class="token function">SwapNFTOutPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><code>_pullTokenInputAndPayProtocolFee</code>解读：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">_pullTokenInputAndPayProtocolFee</span><span class="token punctuation">(</span>
        <span class="token builtin">uint256</span> inputAmount<span class="token punctuation">,</span>                <span class="token comment">// 购买nft需要花费的总金额，已包括：协议手续费和池手续费（若为双边池）</span>
        <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token comment">/*isRouter*/</span>
        <span class="token builtin">address</span><span class="token punctuation">,</span> <span class="token comment">/*routerCaller*/</span>
        IKejinPairFactoryLike _factory<span class="token punctuation">,</span>     <span class="token comment">// 工厂合约</span>
        <span class="token builtin">uint256</span> protocolFee                 <span class="token comment">// 工厂协议手续费</span>
    <span class="token punctuation">)</span> <span class="token keyword">internal</span> override <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">&gt;=</span> inputAmount<span class="token punctuation">,</span> <span class="token string">&quot;Sent too little ETH&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Transfer inputAmount ETH to assetRecipient if it's been set</span>
        <span class="token comment">// 若为双边池_assetRecipient一定指向本本币对合约，若为单边池_assetRecipient为设置的接受资产的地址</span>
        <span class="token comment">// 若单边池未设置_assetRecipient，则也会指向本币对合约（一般单边池不会不设置）</span>
        <span class="token builtin">address</span> <span class="token keyword">payable</span> _assetRecipient <span class="token operator">=</span> <span class="token function">getAssetRecipient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>_assetRecipient <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 由上述方法可知，此safeTransferETH的使用场景一定是单边池</span>
            <span class="token comment">// 将交易者购买nft的钱转给_assetRecipient（扣除协议手续费），协议手续费需要转给工厂合约</span>
            _assetRecipient<span class="token punctuation">.</span><span class="token function">safeTransferETH</span><span class="token punctuation">(</span>inputAmount <span class="token operator">-</span> protocolFee<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Take protocol fee</span>
        <span class="token comment">//</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>protocolFee <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Round down to the actual ETH balance if there are numerical stability issues with the bonding curve calculations</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>protocolFee <span class="token operator">&gt;</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                protocolFee <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>protocolFee <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 将协议手续费需要转给工厂合约</span>
                <span class="token keyword">payable</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span>_factory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">safeTransferETH</span><span class="token punctuation">(</span>protocolFee<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="疑问-此方法-eth-的转移似乎只适用于单边池-没有直接写出双边池-eth-的转移方法"><a href="#疑问-此方法-eth-的转移似乎只适用于单边池-没有直接写出双边池-eth-的转移方法" class="header-anchor">#</a> 疑问：此方法 eth 的转移似乎只适用于单边池，没有直接写出双边池 eth 的转移方法？</h4> <p>router 中调用 pair 的<code>swapTokenForAnyNFTs</code>方法时传入了 value,并且 swapTokenForAnyNFTs 是可 payable 的，因此假如<code>swapTokenForAnyNFTs</code>中没有出现任何<code>safeTransferETH</code>方法，且执行过程没有任何错误，则 evm 会将传入的<code>msg.value</code>自动转移至 payable 方法所在合约的 balance 中（<a href="https://mirror.xyz/ninjak.eth/NTNHraVAn2OWUKXpr0byphlxl8ytj7fRUAaOaLYfEtA" title="接受ETH基础" target="_blank" rel="noopener noreferrer">接受 ETH<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</p> <ul><li>什么是 safeTransferETH? 采用了 call opcode 的方式转移 eth,若 payable 标记的函数中使用了一次 safeTransferETH(amount)，则 evm 会将剩下的钱，即 msg.value-amount 转给合约 balance。
所以双边池收到的 eth 即为 msg.value-protocolFee(其中包含了池手续费作为每完成一笔交易的收益)</li></ul> <hr> <p>作者: 谢伟杰
日期: '2022-11-03'</p> <hr></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/9/2022, 2:40:23 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.5dfd60c4.js" defer></script><script src="/blog/assets/js/2.3dfb7180.js" defer></script><script src="/blog/assets/js/12.fae0daa3.js" defer></script>
  </body>
</html>
